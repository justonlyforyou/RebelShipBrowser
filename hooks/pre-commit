#!/bin/sh
#
# Pre-commit hook for RebelShip Browser
# Runs linting and security checks before allowing commits
#
# To install: copy this file to .git/hooks/pre-commit
# Or run: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "Running pre-commit checks..."

# Get the root directory of the repository
ROOT_DIR=$(git rev-parse --show-toplevel)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

echo ""
echo "=========================================="
echo "  Building with analyzers enabled..."
echo "=========================================="

# Run dotnet build with analyzers
cd "$ROOT_DIR"
BUILD_OUTPUT=$(dotnet build RebelShipBrowser.sln -warnaserror:CA5389,CA5390,CA5391,CA5392,CA5393,CA5394,CA5395,CA5396,CA5397,CA5398,CA5399,CA5400,CA5401,CA5402,CA5403,CA3001,CA3002,CA3003,CA3004,CA3005,CA3006,CA3007,CA3008,CA3009,CA3010,CA3011,CA3012,CA2100 2>&1)
BUILD_RESULT=$?

if [ $BUILD_RESULT -ne 0 ]; then
    echo "${RED}BUILD FAILED${NC}"
    echo "$BUILD_OUTPUT"
    FAILED=1
else
    echo "${GREEN}Build successful${NC}"

    # Check for security warnings (even if build succeeded)
    SECURITY_WARNINGS=$(echo "$BUILD_OUTPUT" | grep -E "(CA5[0-9]{3}|CA3[0-9]{3}|SCS[0-9]{4})" | grep -i "warning")

    if [ -n "$SECURITY_WARNINGS" ]; then
        echo ""
        echo "${YELLOW}Security warnings found:${NC}"
        echo "$SECURITY_WARNINGS"
        echo ""
        echo "${YELLOW}Review these warnings before committing.${NC}"
    fi
fi

echo ""
echo "=========================================="
echo "  Checking for sensitive data..."
echo "=========================================="

# Check for potential secrets in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
    # Patterns that might indicate secrets
    SECRET_PATTERNS="password|secret|api_key|apikey|access_token|auth_token|credentials|private_key"

    for FILE in $STAGED_FILES; do
        if [ -f "$FILE" ]; then
            # Skip binary files and certain extensions
            case "$FILE" in
                *.exe|*.dll|*.pdb|*.ico|*.png|*.jpg|*.gif)
                    continue
                    ;;
            esac

            MATCHES=$(grep -inE "$SECRET_PATTERNS" "$FILE" 2>/dev/null | grep -v "// " | head -5)
            if [ -n "$MATCHES" ]; then
                echo "${YELLOW}Potential secrets in $FILE:${NC}"
                echo "$MATCHES"
                echo ""
            fi
        fi
    done
fi

echo "${GREEN}Sensitive data check complete${NC}"

echo ""
echo "=========================================="
echo "  Checking for forbidden patterns..."
echo "=========================================="

# Check for patterns that should never be committed
FORBIDDEN_FOUND=0

for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        case "$FILE" in
            *.cs)
                # Check for HttpClient, WebClient usage (should not exist in this app)
                HTTP_USAGE=$(grep -n "new HttpClient\|new WebClient\|WebRequest.Create" "$FILE" 2>/dev/null)
                if [ -n "$HTTP_USAGE" ]; then
                    echo "${RED}Forbidden: Direct HTTP client usage in $FILE:${NC}"
                    echo "$HTTP_USAGE"
                    FORBIDDEN_FOUND=1
                fi

                # Check for hardcoded URLs (except allowed ones)
                URLS=$(grep -nE "https?://[^\"' ]+" "$FILE" 2>/dev/null | grep -v "shippingmanager.cc" | grep -v "github.com/justonlyforyou" | grep -v "schemas.microsoft.com" | grep -v "learn.microsoft.com")
                if [ -n "$URLS" ]; then
                    echo "${YELLOW}Review: URLs found in $FILE:${NC}"
                    echo "$URLS"
                fi
                ;;
        esac
    fi
done

if [ $FORBIDDEN_FOUND -eq 1 ]; then
    FAILED=1
fi

echo "${GREEN}Pattern check complete${NC}"

echo ""
echo "=========================================="

if [ $FAILED -eq 1 ]; then
    echo "${RED}Pre-commit checks FAILED${NC}"
    echo "Please fix the issues above before committing."
    exit 1
else
    echo "${GREEN}All pre-commit checks passed!${NC}"
    exit 0
fi
